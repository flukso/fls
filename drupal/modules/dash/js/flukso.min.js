$.ajaxSetup({timeout:4E3});Highcharts.setOptions({global:{useUTC:!1,canvasToolsURL:"sites/all/modules/dash/js/canvas-tools.js"}});window.Flukso={time:{SECOND:1E3,MINUTE:6E4,QUARTER:9E5,HOUR:36E5,DAY:864E5,WEEK:6048E5,MONTH:2592E6,YEAR:31536E6,DECADE:31536E7}};
Flukso.timeParams={minute:{interval:"minute",resolution:"second",resSec:Flukso.time.SECOND,range:Flukso.time.MINUTE},hour:{interval:"day",resolution:"minute",resSec:Flukso.time.MINUTE,range:Flukso.time.HOUR},day:{interval:"week",resolution:"15min",resSec:Flukso.time.QUARTER,range:Flukso.time.DAY},month:{interval:"year",resolution:"day",resSec:Flukso.time.DAY,range:Flukso.time.MONTH},year:{interval:"decade",resolution:"week",resSec:Flukso.time.WEEK,range:Flukso.time.YEAR},night:{interval:"night",resolution:"day",
resSec:Flukso.time.DAY,range:Flukso.time.MONTH}};Flukso.unitParams={electricity:"kwhperyear",gas:"lperday",water:"lperday"};Flukso.unitRtParams={electricity:"watt",gas:"lperday",water:"lperday"};Flukso.unitPowerFactor={electricity:{watt:0.1142,kwhperyear:1,eurperyear:999},gas:{lpermin:6.944E-4,lperday:1,m3peryear:0.365,eurperyear:999},water:{lpermin:6.944E-4,lperday:1,m3peryear:0.365,eurperyear:999}};
Flukso.unitEnergyFactor={electricity:{wh:{minute:1E3*Flukso.time.SECOND/Flukso.time.YEAR,hour:1E3*Flukso.time.MINUTE/Flukso.time.YEAR,day:1E3*Flukso.time.QUARTER/Flukso.time.YEAR,month:1E3*Flukso.time.DAY/Flukso.time.YEAR,year:1E3*Flukso.time.WEEK/Flukso.time.YEAR,night:1E3*Flukso.time.DAY/Flukso.time.YEAR}},gas:{liter:{minute:Flukso.time.SECOND/Flukso.time.DAY,hour:Flukso.time.MINUTE/Flukso.time.DAY,day:Flukso.time.QUARTER/Flukso.time.DAY,month:Flukso.time.DAY/Flukso.time.DAY,year:Flukso.time.WEEK/
Flukso.time.DAY,night:Flukso.time.DAY/Flukso.time.DAY}},water:{liter:{minute:Flukso.time.SECOND/Flukso.time.DAY,hour:Flukso.time.MINUTE/Flukso.time.DAY,day:Flukso.time.QUARTER/Flukso.time.DAY,month:Flukso.time.DAY/Flukso.time.DAY,year:Flukso.time.WEEK/Flukso.time.DAY,night:Flukso.time.DAY/Flukso.time.DAY}}};Flukso.fontFamily='"Droid Sans", "Helvetica Neue", Helvetica, Arial, sans-serif';
Flukso.chartDefaults={chart:{renderTo:"chart",backgroundColor:"#f5f5f5",animation:{duration:400,easing:"swing"},events:{}},colors:"#E41A1C #377EB8 #4DAF4A #FF7F00 #984EA3 #999999 #A65628 #F781BF".split(" "),credits:{enabled:!1},plotOptions:{line:{animation:{duration:400,easing:"swing"},connectNulls:!1,lineWidth:2}},rangeSelector:{enabled:!1},xAxis:{gridLineWidth:1,gridLineDashStyle:"ShortDot",lineColor:"#000",tickColor:"#000",labels:{style:{color:"#000",fontSize:"13px",fontFamily:Flukso.fontFamily}},
title:{style:{color:"#333",fontWeight:"normal",fontSize:"15px",fontFamily:Flukso.fontFamily}}},yAxis:{min:0,minorTickInterval:"auto",gridLineWidth:1,gridLineDashStyle:"ShortDot",minorGridLineDashStyle:"ShortDot",lineColor:"#000",lineWidth:1,tickWidth:1,tickColor:"#000",labels:{style:{color:"#000",fontSize:"13px",fontFamily:Flukso.fontFamily}},title:{style:{color:"#333",fontWeight:"normal",fontSize:"15px",fontFamily:Flukso.fontFamily}}},series:[]};
Flukso.ChartState=Backbone.NestedModel.extend({defaults:{init:!0,reloadChart:!0,refreshData:!1,type:"electricity",interval:"day",unit:{electricity:"watt",gas:"lperday",water:"lperday"},unitRt:{electricity:"watt",gas:"lperday",water:"lperday"},cumul:!1,count:{electricity:0,gas:0,water:0}}});
Flukso.User=Backbone.Model.extend({defaults:{uid:null,name:null,avatar:null,show:!0},initialize:function(){Flukso.chartState.set({reloadChart:!0});Flukso.sensorCollect.GET(this.get("uid"),this.get("name"));this.bind("remove",function(){Flukso.sensorCollect.removeByUid(this.get("uid"))})}});
Flukso.UserCollect=Backbone.Collection.extend({model:Flukso.User,initialize:function(){},getByUid:function(a){return this.find(function(b){return b.get("uid")==a})},getUids:function(){return this.map(function(a){return a.get("uid")})},syncUids:function(){if(!Flukso.chartState.get("init")){var a=_.rest(this.getUids());$.ajax({type:"POST",url:"/dash/subscriptions",contentType:"application/json",data:JSON.stringify(a)})}}});
Flukso.UserView=Backbone.View.extend({el:"#fluksonians",template:_.template($("#avatar-add").html()),initialize:function(){_.bindAll(this,"action","add","remove","show");this.collection.bind("add",this.add);this.collection.add(Drupal.settings.me);_.each(Drupal.settings.subscriptions,function(a){a.show=!1;this.collection.add(a)},this)},events:{"click .avatar":"action"},action:function(a){$("#fluksonian-show").hasClass("active")?this.show(a):this.remove(a)},add:function(a){$(this.el).append(this.template(a.attributes));
!1==a.get("show")&&(a=".avatar [uid="+a.get("uid")+"]",$(a).parent().addClass("grey-out"));this.collection.syncUids()},remove:function(a){var a=a.target,b=Number($(a).attr("uid")),c=this.collection.getByUid(b);Drupal.settings.me.uid!=b&&($(a).parent().remove(),this.collection.remove(c),this.collection.syncUids(),Flukso.chartState.set({reloadChart:!0,refreshData:!Flukso.chartState.get("refreshData")}))},show:function(a){var a=a.target,b=this.collection.getByUid(Number($(a).attr("uid")));b.set({show:!b.get("show")});
$(a).parent().toggleClass("grey-out");Flukso.chartState.set({reloadChart:!0})}});
Flukso.UserCtrlView=Backbone.View.extend({el:"#fluksonian-ctrl",initialize:function(){0==Drupal.settings.me.uid?($("#fluksonians").parent().remove(),$(this.el).parent().remove()):($(this.el).show(),_.bindAll(this,"add"),$("#fluksonian-show").addClass("active"),this.add())},add:function(){var a=this;$("#fluksonian-add").typeahead({source:function(a,c){return $.getJSON("/dash/user/autocomplete/"+c).success(function(c){a.process(c)})},property:"name",onselect:function(b){a.collection.getByUid(b.uid)||
a.collection.add(b);$("#fluksonian-add").val("")}})}});
Flukso.Sensor=Backbone.Model.extend({defaults:{id:null,uid:null,userName:null,type:null,"function":null,interval:null,unit:null,unitRt:null,data:null,baseUrl:"https://www.flukso.net/api/sensor/",localUrl:null,callback:"?callback=?",version:"1.0",fetching:null,timeoutId:null},initialize:function(){this.set({unit:Flukso.unitParams[this.get("type")],unitRt:Flukso.unitRtParams[this.get("type")]});this.GET=_.bind(this.GET,this);Flukso.chartState.bind("change:refreshData",this.GET);Flukso.chartState.bind("change:type",
this.GET);Flukso.chartState.bind("change:interval",this.GET);Flukso.chartState.bind("change:unit",this.GET);Flukso.chartState.bind("change:cumul",this.GET);Flukso.userCollect.bind("change:show",this.GET);this.GET()},decouple:function(){Flukso.chartState.unbind("change:refreshData",this.GET);Flukso.chartState.unbind("change:type",this.GET);Flukso.chartState.unbind("change:interval",this.GET);Flukso.chartState.unbind("change:unit",this.GET);Flukso.chartState.unbind("change:cumul",this.GET);Flukso.userCollect.unbind("change:show",
this.GET)},GET:function(){function a(a){var b=Flukso.timeParams[this.get("interval")].resSec;this.set({data:_.map(a,function(a){a[0]=1E3*a[0]-b;return a}),fetching:!1})}function b(a,b){clearTimeout(this.get("timeoutId"));"timeout"==b&&Flukso.alertView.timeoutRt(this.get("function"))}if(Flukso.chartState.get("type")==this.get("type")&&Flukso.userCollect.getByUid(this.get("uid")).get("show")){this.set({fetching:!0,interval:Flukso.chartState.get("interval")},{silent:!0});var a=_.bind(a,this),b=_.bind(b,
this),c={version:this.get("version"),interval:Flukso.timeParams[this.get("interval")].interval,resolution:Flukso.timeParams[this.get("interval")].resolution,unit:"minute"==this.get("interval")?this.get("unitRt"):this.get("unit")};"minute"==this.get("interval")?null==this.get("localUrl")?Flukso.alertView.noRealtime():($.getJSON(this.get("localUrl")+this.get("id")+this.get("callback"),c).success(a).error(b),this.set({timeoutId:setTimeout(this.GET,1E3)})):$.getJSON(this.get("baseUrl")+this.get("id")+
this.get("callback"),c).success(a)}}});
Flukso.SensorCollect=Backbone.Collection.extend({model:Flukso.Sensor,initialize:function(){this.attributes={baseUrl:"https://www.flukso.net/api/user/",callback:"?callback=?",version:"1.0"}},comparator:function(a){var b=Flukso.userCollect.getByUid(a.get("uid"));return 1E3+Number(b.cid.substring(1))+a.get("function").toLowerCase()},getByUid:function(a){return this.filter(function(b){return b.get("uid")==a})},removeByUid:function(a){var b=this;_.each(this.getByUid(a),function(a){b.remove(a);a.decouple()})},
GET:function(a,b){function c(c){var e={electricity:Flukso.chartState.get("count.electricity"),gas:Flukso.chartState.get("count.gas"),water:Flukso.chartState.get("count.water")},d;for(d in c)this.add({id:c[d].sensor,uid:Number(a),userName:b,type:c[d].type,"function":c[d]["function"],localUrl:"undefined"==c[d].ip?null:"http://"+c[d].ip+":"+c[d].port+"/sensor/"}),e[c[d].type]++;Flukso.chartState.set({count:{electricity:e.electricity,gas:e.gas,water:e.water}});Flukso.chartState.get("init")||Flukso.chartState.set({refreshData:!Flukso.chartState.get("refreshData")})}
c=_.bind(c,this);$.getJSON(this.attributes.baseUrl+a+"/sensor"+this.attributes.callback,{version:this.attributes.version},c)}});
Flukso.TypeView=Backbone.View.extend({el:"[menu=type]",initialize:function(){_.bindAll(this,"render","clickButton");this.model.bind("change:type",this.render);$("[menu=type]").click(this.clickButton);this.render()},render:function(){$("[menu=type] li a").removeClass("active");var a="[typ="+this.model.get("type")+"]";$(a).button("toggle");return this},events:{},clickButton:function(a){Flukso.alertView.clear();this.model.set({type:$(a.target).attr("typ")});this.model.set({cumul:!1});this.model.set({reloadChart:!0})}});
Flukso.IntervalView=Backbone.View.extend({el:"[menu=interval]",initialize:function(){_.bindAll(this,"render","clickButton");this.model.bind("change:interval",this.render);$("[menu=interval]").click(this.clickButton);this.render()},render:function(){$("[menu=interval] li a").removeClass("active");var a="[interval="+this.model.get("interval")+"]";$(a).button("toggle");return this},events:{},clickButton:function(a){Flukso.alertView.clear();this.model.set({interval:$(a.target).attr("interval")});this.model.set({reloadChart:!0})}});
Flukso.UnitView=Backbone.View.extend({el:"[menu=unit]",initialize:function(){_.bindAll(this,"render","clickDropdown");this.model.bind("change:type",this.render);this.model.bind("change:interval",this.render);$("[menu=unit]").click(this.clickDropdown);this.render()},render:function(){$("[menu=unit].dropdown-menu a").hide();var a="[menu=unit].dropdown-menu a."+this.model.get("type");"minute"==this.model.get("interval")&&(a+=".rt");$(a).show();return this},events:{},clickDropdown:function(a){Flukso.alertView.clear();
var b={electricity:this.model.get("unit.electricity"),gas:this.model.get("unit.gas"),water:this.model.get("unit.water")},a=a.target;b[this.model.get("type")]=$(a).attr("unit");this.model.set({unit:{electricity:b.electricity,gas:b.gas,water:b.water}});this.model.set({cumul:$(a).hasClass("cumul")});this.model.set({reloadChart:!0})}});
Flukso.AlertView=Backbone.View.extend({el:"#alert",initialize:function(){_.bindAll(this,"verifyNumSensors");_.bindAll(this,"noRealtime");_.bindAll(this,"timeoutRt");_.bindAll(this,"clear");this.model.bind("change:type",this.verifyNumSensors)},verifyNumSensors:function(){var a=this.model.get("type");if(0==this.model.get("count."+a)){var b=_.template($("#alert-no-sensor").html());$(this.el).html(b({type:a}))}return this},noRealtime:function(){var a=_.template($("#alert-no-realtime").html());$(this.el).html(a())},
timeoutRt:function(a){var b=_.template($("#alert-timeout-rt").html());$(this.el).html(b({func:a}))},clear:function(){$(this.el).empty()}});
Flukso.ChartView=Backbone.View.extend({initialize:function(){this.collection.bind("change:fetching",this.render)},render:function(){var a=this.map(function(a){return!0==a.get("fetching")?1:0});if(_.reduce(a,function(a,b){return a+b},0))return this;Flukso.chartState.set({init:!1});var b=Flukso.chartState.get("type"),c=Flukso.chartState.get("interval");if("minute"==c)var a=Flukso.chartState.get("unitRt."+b),g=!1,e=1;else a=Flukso.chartState.get("unit."+b),g=Flukso.chartState.get("cumul"),e=Flukso.unitPowerFactor[b][a]?
Flukso.unitPowerFactor[b][a]:Flukso.unitEnergyFactor[b][a][c];var d=this.filter(function(a){return a.get("type")==b&&a.get("interval")==c&&Flukso.userCollect.getByUid(a.get("uid")).get("show")&&_.find(a.get("data"),function(a){return"nan"!=a[1]})}),d=_.map(d,function(a){function b(a){return a[0]<d?!1:!0}var d=_.last(a.get("data"))[0]-Flukso.timeParams[c].range;return{name:a.get("userName")+"."+a.get("function"),data:_.map(g?_.filter(a.get("data"),b):a.get("data"),function(a,b,c){"nan"==a[1]?a[1]=
null:(a[1]*=e,g&&0!=b&&(a[1]+=c[b-1][1]));return a}),step:!0,tooltip:{yDecimals:0}}});if(Flukso.chartState.get("reloadChart")){Flukso.chartState.set({reloadChart:!1});var f=$.extend(!0,{},Flukso.chartDefaults);f.xAxis.range=Flukso.timeParams[c].range;f.yAxis.title.text=a;f.series=d;Flukso.chart=new Highcharts.StockChart(f)}else _.each(d,function(a,b){Flukso.chart.series[b].setData(a.data)});return this}});
Flukso.Router=Backbone.Router.extend({routes:{":type/:interval":"gotoChart"},initialize:function(){_.bindAll(this,"updateRoute");Flukso.chartState.bind("change",this.updateRoute)},updateRoute:function(){var a=Flukso.chartState.get("type"),b=Flukso.chartState.get("interval");this.navigate(a+"/"+b,!0)},gotoChart:function(a,b){Flukso.chartState.set({type:a,interval:b,reloadChart:!0})}});
$(function(){Flukso.chartState=new Flukso.ChartState;Flukso.sensorCollect=new Flukso.SensorCollect;Flukso.userCollect=new Flukso.UserCollect;Flukso.typeView=new Flukso.TypeView({model:Flukso.chartState});Flukso.intervalView=new Flukso.IntervalView({model:Flukso.chartState});Flukso.unitView=new Flukso.UnitView({model:Flukso.chartState});Flukso.alertView=new Flukso.AlertView({model:Flukso.chartState});Flukso.chartView=new Flukso.ChartView({collection:Flukso.sensorCollect});Flukso.userView=new Flukso.UserView({collection:Flukso.userCollect});
Flukso.userCtrlView=new Flukso.UserCtrlView({collection:Flukso.userCollect});Flukso.router=new Flukso.Router;Backbone.history.start({root:"/dash"});Flukso.router.updateRoute()});